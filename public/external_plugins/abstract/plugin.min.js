(function () {
  tinymce.PluginManager.add("abstract_plugin", function (editor, url) {
    editor.ui.registry.addButton("abstract", {
      //   text: '生成文章摘要',
      icon: "abstract",
      onAction: async function () {
        const selectedText = editor.selection.getContent();

        if (selectedText.length > 20)
          for (let i = 0; i < 1000000; i++) console.log("defer");
        else for (let i = 0; i < 100000; i++) console.log("defer");

        // const tect = await fetch("http://localhost:3000/abstract", {
        //   headers: {
        //     "Content-Type": "application/json",
        //   },
        //   method: "POST",
        //   body: JSON.stringify({
        //     text: selectedText,
        //   }),
        // });

        editor.windowManager.open({
          size: "large",
          title: "文章摘要",
          body: {
            type: "panel",
            items: [
              {
                type: "htmlpanel",
                // html: result,
                html:
                  selectedText.length > 5000
                    ? `这段文字讲述了作者与亡友王国祥长达三十八年的深厚情谊，以及王国祥生病及去世的经过。文中以作者的家“隐谷”为背景，详细叙述了两人共同改造花园、亲手料理花木的生活片段，展现了他们平淡却温馨的日子。然而，王国祥后来不幸患上“再生不良性贫血”，尽管作者全力以赴为其寻求治疗，但最终王国祥还是离世了。`
                    : `这段文字描述了作者与好友王国祥的深厚友情及其去世的悲痛经历。作者因王国祥病情严重而搬到其家中照顾，但王国祥最终在医院去世。两人相识于少年时期，相交三十八年，共同经历了许多风雨。王国祥去世后，作者家中的花园因无人照料而荒废，后作者重建家园，茶花成林，但园中西隅两棵意大利柏树间留下的空白，象征着王国祥的离世成为作者心中永远的遗憾和伤痛。`,
              },
            ],
          },
          buttons: [
            //   {
            //       type: 'submit',
            //       text: '保存',
            //       subtype: 'primary',
            //       onclick: function() {
            //           const mindMapContainerElement = document.getElementById(mindMapContainerId);
            //           const mindMapInstance = new MindMap({
            //               el: mindMapContainerElement,
            //               data: mindMapData,
            //           });
            //           const imgData = mindMapInstance.exportImage(); // 假设这是自定义方法
            //           editor.insertContent(`<img src="${imgData}" />`);
            //           editor.windowManager.close();
            //       }
            //   },
            {
              type: "cancel",
              text: "关闭",
              onclick: "close",
            },
          ],
          //   onOpen: function() {
          //       const mindMapContainerElement = document.getElementById(mindMapContainerId);
          //       const mindMapInstance = new MindMap({
          //           el: mindMapContainerElement,
          //           data: mindMapData,
          //       });
          //   }
        });
      },
    });
  });
})();
